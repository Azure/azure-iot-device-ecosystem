---
platform: nrf connect
device: nordic
language: c
---

Run the nRF Connect SDK Azure IoT Hub sample on Nordic Semiconductor's nRF9160
===
---

# Table of Contents

-   [Introduction](#Introduction)
-   [Step 1: Prerequisites](#Prerequisites)
-   [Step 2: Prepare your Device](#PrepareDevice)
-   [Step 3: Configure, Build, and Run the Sample](#Build)
-   [Next Steps](#NextSteps)

<a name="Introduction"></a>
# Introduction

**About this document**

This document describes how to connect Nordic Semiconductor's nRF9160 running Zephyr with the [Azure IoT Hub sample][ncs-azure-iot-hub-sample] from the [nRF Connect SDK][ncs]. This multi-step process includes:

-   Configuring Azure IoT Hub
-   Provision the certificates onto the device
-   Building, flashing and running the sample on the device

**About the nRF Connect SDK Azure IoT Hub sample**

[The sample][ncs-azure-iot-hub-sample] supports the direct connection of an IoT device that is already registered to an Azure IoT Hub instance. Alternatively, it supports the provisioning of the device using [Azure IoT Hub Device Provisioning Service (DPS)][dps] to an IoT hub. See the documentation on [Azure IoT Hub library][ncs-azure-iot-hub-library] for more information.

The sample periodically publishes telemetry messages (events) to the connected Azure IoT Hub instance. By default, telemetry messages are sent every 20 seconds. The default interval can be configured by setting the device twin property `desired.telemetryInterval`, which will be interpreted by the sample in units of seconds. The format of a telemetry message is shown below:

```json
    {
       "temperature": 25.2,
       "timestamp": 151325
    }
```

where `temperature` is a value between `25.0` and `25.9`, and `timestamp` is the uptime of the device in milliseconds.

The sample has implemented the handling of [Azure IoT Hub direct method][direct-method] with the name `led`. If the device receives a direct method invocation with the name led and payload `1` or `0`, LED 1 on the device is turned on or off, depending on the payload. On Thingy:91, the LED turns red if the payload is `1`.

<a name="Prerequisites"></a>
# Step 1: Prerequisites

You should have the following items ready before beginning the process:

-   [Prepare your development environment][setup-ncs] for the [nRF Connect SDK][ncs]
-   [Setup your IoT hub][lnk-setup-iot-hub]
-   [Provision your device and get its credentials][lnk-manage-iot-hub]
-   acquire a nRF9160 Development Kit, for example the [Thingy:91][thingy-91] or the [nRF9160 DK][nrf9160-dk]

<a name="PrepareDevice"></a>

# Step 2: Prepare your Device
The Azure IoT Hub library requires the provisioning of the following certificates and a private key for a successful TLS connection:

-   [Baltimore CyberTrust Root certificate][root-cert] - Server certificate, used to verify the server’s certificate while connecting.
-   Device certificate - generated by the procedures described in [Creating Azure IoT Hub certificates][create-certs], used by Azure IoT Hub to authenticate the device.
-   Private key of the device.

## Provisioning of the certificates

To provision the certificates and the private key to the nRF9160 modem, complete the following steps:

-   Download [nRF Connect for Desktop][nrfconnect-desktop].
-   Update the modem firmware on the onboard modem of the nRF9160-based device to the latest version by following the steps in [Updating the nRF9160 DK cellular modem][updating-modem].
-   Build and program the [nRF9160: AT Client][at-client] sample to the nRF9160-based device as explained in [Building and programming a sample application][building-sample].
-   Launch the [LTE Link Monitor application][lte-linkmonitor], which is part of [nRF Connect for Desktop][nrfconnect-desktop].
-   Click _Certificate manager_ located at the top right corner.
-   Copy the [Baltimore CyberTrust Root certificate][root-cert] into the `CA certificate` entry.
-   Copy and paste the device certificate and the key created using the scripts located in [Creating Azure IoT Hub certificates][create-certs], into the respective entries (`Client certificate`, `Private key`).
-   Select a desired security tag (any positive integer, for example, `42`) and click _Update certificates_.

<a name="Build"></a>
# Step 3: Configure, Build, and Run the sample

This sample can be found under [`samples/nrf9160/azure_iot_hub`][sample-location] in the nRF Connect SDK folder structure.

## Step 3.1: Configure the sample

Check and configure the following library options that are used by the sample:

-   `CONFIG_AZURE_IOT_HUB_DEVICE_ID` - Sets the Azure IoT Hub device ID. Alternatively, enable `CONFIG_AZURE_IOT_HUB_DEVICE_ID_APP` option and set the device ID at run time in `azure_iot_hub_config` passed to the `azure_iot_hub_init()` function.
-   `CONFIG_AZURE_IOT_HUB_HOSTNAME` - Sets the Azure IoT Hub host name. If DPS is used, the sample assumes that the IoT hub host name is unknown, and the configuration is ignored.
-   `CONFIG_AZURE_IOT_HUB_DPS` - Enables Azure IoT Hub DPS.
-   `CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE` - Sets the Azure IoT Hub DPS ID scope.

## Step 3.2: Build the sample

The sample is built as a non-secure firmware image for the `nrf9160dk_nrf9160ns` build target. Because of this, it automatically includes the [Secure Partition Manager][spm].

See [Building and programming a sample application][building-sample] for information about how to build and program the application.

The sample is configured to compile and run as a non-secure application on nRF91’s Cortex-M33. Therefore, it automatically includes the [Secure Partition Manager][spm] that prepares the required peripherals to be available for the application.

## Step 3.3: Run the sample

After programming the sample to your development kit, test it by performing the following steps:

-   Connect the kit to the computer using a USB cable. The kit is assigned a COM port (Windows) or ttyACM device (Linux), which is visible in the Device Manager.
-   Connect to the kit with a terminal emulator (for example, PuTTY). See [How to connect with PuTTY](connect-with-putty) for the required settings.
-   Reset the development kit.
-   Observe the log output and verify that it is similar to the [Sample Output](#sampoutput).
-   Select the connected IoT hub and then your device.
-   Change the device twin’s `desired` property `telemetryInterval` to a new value, for instance `10`, and save the updated device twin. If it does not exist, you can add the `desired` property.
-   Observe that the device receives the updated `telemetryInterval` value, applies it, and starts sending new telemetry events every 10 seconds.
-   Verify that the `reported` object in the device twin now has a `telemetryInterval` property with the correct value reported back from the device.
-   On the device page, navigate to the Direct method tab.
-   Enter `led` as the method name. In the `payload` field, enter the value `1` (or `0`) and click Invoke method.
-   Observe that LED 1 on the development kit lights up (or switches off if `0` is entered as the payload).

<a name="sampoutput"></a>
### Sample Output

When the sample runs, the device boots, and the sample displays an output identical to the following output in the terminal over UART:

    **Booting Zephyr OS build v2.3.0-rc1-ncs1-1453-gf41496cd30d5**
    Azure IoT Hub sample started
    Connecting to LTE network
    Connected to LTE network
    AZURE_IOT_HUB_EVT_CONNECTING
    AZURE_IOT_HUB_EVT_CONNECTED
    AZURE_IOT_HUB_EVT_READY
    AZURE_IOT_HUB_EVT_TWIN_RECEIVED
    No 'telemetryInterval' object in the device twin
    Sending event:
    {"temperature":25.9,"timestamp":16849}
    Event was successfully sent
    Next event will be sent in 20 seconds

    AZURE_IOT_HUB_EVT_TWIN`desired`RECEIVED
    New telemetry interval has been applied: 60
    AZURE_IOT_HUB_EVT_TWIN_RESULT_SUCCESS, ID: 42740
    Sending event:
    {"temperature":25.5,"timestamp":47585}
    Event was successfully sent
    Next event will be sent in 60 seconds


<a name="NextSteps"></a>
# Next Steps

You have now learned how to run a sample application that collects sensor data and sends it to your IoT hub. To explore how to store, analyze and visualize the data from this application in Azure using a variety of different services, please click on the following lessons:

-   [Manage cloud device messaging with iothub-explorer]
-   [Save IoT Hub messages to Azure data storage]
-   [Use Power BI to visualize real-time sensor data from Azure IoT Hub]
-   [Use Azure Web Apps to visualize real-time sensor data from Azure IoT Hub]
-   [Weather forecast using the sensor data from your IoT hub in Azure Machine Learning]
-   [Remote monitoring and notifications with Logic Apps]

[manage cloud device messaging with iothub-explorer]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-explorer-cloud-device-messaging
[save iot hub messages to azure data storage]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-store-data-in-azure-table-storage
[use power bi to visualize real-time sensor data from azure iot hub]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-live-data-visualization-in-power-bi
[use azure web apps to visualize real-time sensor data from azure iot hub]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-live-data-visualization-in-web-apps
[weather forecast using the sensor data from your iot hub in azure machine learning]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-weather-forecast-machine-learning
[remote monitoring and notifications with logic apps]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-monitoring-notifications-with-azure-logic-apps
[lnk-setup-iot-hub]: ../../setup_iothub.md
[lnk-manage-iot-hub]: ../../manage_iot_hub.md
[ncs-azure-iot-hub-sample]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/nrf9160/azure_iot_hub/README.html
[setup-ncs]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/getting_started.html
[ncs]: https://www.nordicsemi.com/Software-and-tools/Software/nRF-Connect-SDK
[thingy-91]: https://www.nordicsemi.com/Software-and-tools/Prototyping-platforms/Nordic-Thingy-91
[nrf9160-dk]: https://www.nordicsemi.com/Software-and-tools/Development-Kits/nRF9160-DK
[dps]: https://docs.microsoft.com/en-us/azure/iot-dps/
[ncs-azure-iot-hub-library]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/net/azure_iot_hub.html#lib-azure-iot-hub
[direct-method]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-direct-methods
[root-cert]: https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt.pem
[create-certs]: https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started
[nrfconnect-desktop]: https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Connect-for-desktop/Download#infotabs
[updating-modem]: https://infocenter.nordicsemi.com/topic/ug_nc_programmer/UG/nrf_connect_programmer/ncp_updating_modem_nrf9160dk.html
[at-client]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/nrf9160/at_client/README.html#at-client-sample
[building-sample]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/gs_programming.html#gs-programming
[lte-linkmonitor]: https://infocenter.nordicsemi.com/topic/ug_link_monitor/UG/link_monitor/lm_intro.html
[sample-location]: https://github.com/nrfconnect/sdk-nrf/tree/master/samples/nrf9160/azure_iot_hub
[spm]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/spm/README.html#secure-partition-manager
[connect-with-putty]: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/gs_testing.html#putty
